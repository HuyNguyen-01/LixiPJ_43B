<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L√¨ X√¨ 4K Gold - Classic Audio Edition</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        @media (orientation: landscape) {
            body, html {
                margin: 0; padding: 0;
                width: 100%; height: 100%;
                overflow: hidden;
                background-color: #000;
                display: flex;
                justify-content: center;
                align-items: center;
                font-family: 'Segoe UI', sans-serif;
            }

            .main-container {
                position: relative;
                width: 100vw;
                height: 56.25vw; 
                max-height: 100vh;
                max-width: 177.78vh; 
                background-image: url('/Back.png');
                background-size: 100% 100%;
                background-repeat: no-repeat;
                background-position: center;
            }

            #roller-container {
                position: absolute;
                top: 35%;
                left: 50%;
                transform: translate(-50%, -50%);
                display: flex;
                overflow: hidden;
                height: 10vw;
                pointer-events: none;
            }

            .digit-column {
                position: relative;
                width: 5vw;
                height: 100%;
                display: flex;
                flex-direction: column;
                transition: transform 3s cubic-bezier(0.15, 0, 0.15, 1);
            }

            .digit {
                height: 10vw;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 8vw;
                font-weight: 900;
                color: #f3d291;
                font-family: 'Arial Black', sans-serif;
                flex-shrink: 0;
            }

            .separator {
                font-size: 8vw;
                font-weight: 900;
                color: #f3d291;
                font-family: 'Arial Black', sans-serif;
                display: flex;
                align-items: center;
                margin: 0 0.5vw;
            }

            .gold-active .digit, .gold-active .separator {
                background: linear-gradient(
                    -45deg, 
                    #462523 0%, #cb9b51 22%, #f6e27a 45%, #f6f2c0 50%, #f6e27a 55%, #cb9b51 78%, #462523 100%
                );
                background-size: 400% 400%;
                color: transparent !important;
                -webkit-background-clip: text;
                background-clip: text;
                animation: goldRoll 4s ease-in-out infinite;
                filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.5));
            }

            @keyframes goldRoll {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }

            .btn-nhan {
                position: absolute;
                bottom: 8%;
                left: 50%;
                transform: translateX(-50%);
                width: 18%;
                aspect-ratio: 1/1;
                background-image: url('/But.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                background-color: transparent;
                border: none;
                cursor: pointer;
                outline: none;
                transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                z-index: 10;
            }

            .btn-nhan:hover { transform: translateX(-50%) scale(1.1); }
            .btn-nhan:active { transform: translateX(-50%) scale(0.9); }
            .is-rolling { pointer-events: none; }

                    /* ===== MUSIC BUTTON ===== */
            .music-btn {
                position: absolute;
                top: 5%;
                right: 7%;
                width: 5vw;
                height: 5vw;
                min-width: 40px;
                min-height: 40px;
                border-radius: 50%;
                border: 2px solid #f3d291;
                background: transparent;
                color: #f3d291;
                font-size: 2.5vw;
                cursor: pointer;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 20;
            }

            .music-btn.playing {
                animation: spin 2s linear infinite;
            }

            @keyframes spin {
                from { transform: rotate(0deg); }
                to   { transform: rotate(360deg); }
            }
        }

        @media (orientation: portrait) {
            body, html {
                margin: 0;
                padding: 0;
                width: 100%;
                /* S·ª≠ d·ª•ng dvh (Dynamic Viewport Height) ƒë·ªÉ l·∫•p ƒë·∫ßy c·∫£ khi thanh ƒëi·ªÅu h∆∞·ªõng hi·ªán/·∫©n */
                height: 100vh;
                height: 100dvh;
                overflow: hidden;
                background-color: #000;
                font-family: 'Segoe UI', sans-serif;
            }

            .main-container {
                position: relative;
                width: 100%;
                height: 100%;
                background-position: center;
                background-repeat: no-repeat;
                display: flex;
                justify-content: center;
                align-items: center;
                background-image: url('/Back_H.png');
                background-size: 100% 100%;
            }

            #roller-container {
                position: absolute;
                left: 50%;
                top: 40%;
                transform: translate(-50%, -50%);
                display: flex;
                overflow: hidden;
                
                height: 16vw;
                gap: 1.5vw;
            }

            .digit-column {
                position: relative;
                width: 9vw;
                height: 16vw;
                display: flex;
                flex-direction: column;
                transition: transform 3s cubic-bezier(0.15, 0, 0.15, 1);
                
            }

            .digit {
                height: 18vw;
                display: flex;
                justify-content: center;
                align-items: center;
                font-size: 15vw;
                line-height: 1;
                font-weight: 900;
                color: #f3d291;
                font-family: 'Arial Black', sans-serif;
                flex-shrink: 0;
            }

            .separator {
                font-size: 7vw;
                font-weight: 900;
                color: #f3d291;
                font-family: 'Arial Black', sans-serif;
                display: flex;
                align-items: center;
                margin: 0 0.5vw;
                height: 16vw;
                transform: translateY(3vw); /* üëà d·ªãch xu·ªëng */
            }

            .gold-active .digit, .gold-active .separator {
                background: linear-gradient(
                    -45deg, 
                    #462523 0%, #cb9b51 22%, #f6e27a 45%, #f6f2c0 50%, #f6e27a 55%, #cb9b51 78%, #462523 100%
                );
                background-size: 400% 400%;
                color: transparent !important;
                -webkit-text-fill-color: transparent;
                -webkit-background-clip: text;
                background-clip: text;
                animation: goldRoll 4s ease-in-out infinite;
                /* filter: drop-shadow(0 0 8px rgba(255, 215, 0, 0.5)); */
                filter: none
            }

            @keyframes goldRoll {
                0% { background-position: 0% 50%; }
                50% { background-position: 100% 50%; }
                100% { background-position: 0% 50%; }
            }

            .btn-nhan {
                position: absolute;
                bottom: 8%;
                left: 50%;
                transform: translateX(-50%);
                width: 40%;
                aspect-ratio: 1/1;
                background-image: url('/But.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-position: center;
                background-color: transparent;
                border: none;
                cursor: pointer;
                outline: none;
                transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
                z-index: 10;
            }

            .btn-nhan:hover { transform: translateX(-50%) scale(1.1); }
            .btn-nhan:active { transform: translateX(-50%) scale(0.9); }
            .is-rolling { pointer-events: none; }

                    /* ===== MUSIC BUTTON ===== */
            .music-btn {
                position: absolute;
                top: 2%;
                right: 7%;
                width: 5vw;
                height: 5vw;
                min-width: 40px;
                min-height: 40px;
                border-radius: 50%;
                border: 2px solid #f3d291;
                background: transparent;
                color: #f3d291;
                font-size: 5vw;
                cursor: pointer;
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 20;
            }

            .music-btn.playing {
                animation: spin 2s linear infinite;
            }

            @keyframes spin {
                from { transform: rotate(0deg); }
                to   { transform: rotate(360deg); }
            }
        }

    </style>
</head>
<body>


<audio id="winSound" 
       src="https://raw.githubusercontent.com/HuyNguyen-01/LixiPJ_43B/main/resouce/2.mp3"
       preload="auto">
</audio>

<div class="main-container">
    <div id="roller-container">
        <div class="digit-column" id="col-1"></div>
        <div class="digit-column" id="col-2"></div>
        <div class="digit-column" id="col-3"></div>
        <div class="separator">.</div>
        <div class="digit-column" id="col-4"></div>
        <div class="digit-column" id="col-5"></div>
        <div class="digit-column" id="col-6"></div>
    </div>
    <button class="btn-nhan" id="rollBtn" onclick="handleClick()"></button>
        <!-- ===== MUSIC BUTTON ===== -->
    <button class="music-btn" id="musicBtn">‚ô™</button>


</div>

<script>
     // ===== WEBSOCKET (THU·∫¶N) =====
    const protocol = location.protocol === "https:" ? "wss://" : "ws://";
    const ws = new WebSocket(protocol + location.host + "/ws");


    ws.onopen = () => {
        console.log("WebSocket connected");
    };

    ws.onmessage = (event) => {
        console.log("WS message:", event.data);

        if (event.data === "spin_now") {
        startRolling();
        }
    };

    ws.onclose = () => {
        console.log("WebSocket disconnected");
    };
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    
    // Kh√¥i ph·ª•c ti·∫øng "t√≠ch t√≠ch" ƒëi·ªán t·ª≠ c≈©
    function playTickSound() {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'square';
        osc.frequency.setValueAtTime(150, audioCtx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(40, audioCtx.currentTime + 0.1);
        gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.1);
    }

    // Kh√¥i ph·ª•c ti·∫øng chu√¥ng th·∫Øng gi·∫£i vui tai
    // function playWinSound() {
    //     const notes = [523.25, 659.25, 783.99, 1046.50]; // ƒê√¥ - Mi - Sol - ƒê√¥
    //     notes.forEach((freq, i) => {
    //         const osc = audioCtx.createOscillator();
    //         const gain = audioCtx.createGain();
    //         osc.type = 'triangle';
    //         osc.frequency.setValueAtTime(freq, audioCtx.currentTime + i * 0.15);
    //         gain.gain.setValueAtTime(0.2, audioCtx.currentTime + i * 0.15);
    //         gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + i * 0.15 + 0.5);
    //         osc.connect(gain);
    //         gain.connect(audioCtx.destination);
    //         osc.start(audioCtx.currentTime + i * 0.15);
    //         osc.stop(audioCtx.currentTime + i * 0.15 + 0.5);
    //     });
    // }

    function playWinSound() {
        const audio = document.getElementById('winSound');
        audio.currentTime = 0; // ph√°t l·∫°i t·ª´ ƒë·∫ßu
        audio.play();
    }



    //const denominations = ["010.000", "020.000", "050.000", "100.000", "200.000", "500.000"];
    const DEFAULT_DENOMINATIONS = [
        { value: 10000, weight: 25 },
        { value: 20000, weight: 25 },
        { value: 50000, weight: 25 },
        { value: 100000, weight: 25 }
    ];
    
    let denominations = [...DEFAULT_DENOMINATIONS];

    async function loadMoneyConfig() {
        try {
            const res = await fetch("/money-config");
            if (!res.ok) throw new Error("fetch failed");

            const data = await res.json();

            if (Array.isArray(data) && data.length) {
            denominations = data;
            console.log("Loaded config from backend", denominations);
            } else {
            throw new Error("invalid data");
            }
        } catch (e) {
            denominations = [...DEFAULT_DENOMINATIONS];
            console.warn("Using default config");
        }
    }

    function getRandomMoney() {
        const total = denominations.reduce((s, d) => s + d.weight, 0);
        let r = Math.random() * total;
        for (const d of denominations) {
        if (r < d.weight) return d.value;
        r -= d.weight;
        }
    }

    const columns = [
        document.getElementById('col-1'), document.getElementById('col-2'), document.getElementById('col-3'),
        document.getElementById('col-4'), document.getElementById('col-5'), document.getElementById('col-6')
    ];

    const rollerContainer = document.getElementById('roller-container');
    const btn = document.getElementById('rollBtn');
    let isRollingState = false;

    function initColumns() {
        columns.forEach(col => {
            col.innerHTML = '';
            for (let i = 0; i < 40; i++) {
                const div = document.createElement('div');
                div.className = 'digit';
                div.innerText = Math.floor(Math.random() * 10);
                col.appendChild(div);
            }
        });
    }

    initColumns();

    function handleClick() {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        if (isRollingState) return;
        startRolling();
    }

    function getDigitHeight(col) {
        const digit = col.querySelector('.digit');
        if (!digit) return 0;
        return digit.getBoundingClientRect().height; // px th·∫≠t
    }

    function startRolling() {
        isRollingState = true;
        btn.classList.add('is-rolling');
        rollerContainer.classList.remove('gold-active');

        //const resultStr = denominations[Math.floor(Math.random() * denominations.length)].replace('.', '');
        const resultStr = String(getRandomMoney()).padStart(6, "0");
        const targetDigits = resultStr.split('');

        // T·∫ßn su·∫•t click nhanh li√™n t·ª•c cho ƒë·∫øn khi d·ª´ng
        // let tickInterval = setInterval(playTickSound, 100);
        
        columns.forEach((col, index) => {
            col.style.transition = 'none';
            col.style.transform = 'translateY(0)';
            col.offsetHeight; 

            const digits = col.querySelectorAll('.digit');
            const lastDigit = digits[digits.length - 1];
            if (lastDigit) {
                lastDigit.innerText = targetDigits[index];
            }

            const digitHeight = getDigitHeight(col);
            const moveY = (col.children.length - 1) * digitHeight;

            col.style.transition = `transform ${3.8 - index * 0.3}s cubic-bezier(0.15, 0, 0.15, 1)`;
            col.style.transform = `translateY(-${moveY}px)`;
        });

        // Ng·∫Øt ti·∫øng tick khi g·∫ßn d·ª´ng h·∫≥n
        // setTimeout(() => clearInterval(tickInterval), 2500);
        setTimeout(() => finishRoll(), 4000);
    }

    function finishRoll() {
        playWinSound();
        rollerContainer.classList.add('gold-active');
        fireworks();
        setTimeout(() => { 
            isRollingState = false;
            btn.classList.remove('is-rolling');
        }, 4000);
    }
    function fireworks() {
        const colors = ['#FFD700', '#FFFFFF', '#FFA500'];
        const canvas = document.createElement('canvas');
        canvas.style.position = 'fixed';
        canvas.style.pointerEvents = 'none';
        canvas.style.top = 0;
        canvas.style.left = 0;
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        canvas.style.zIndex = 9999;
        document.body.appendChild(canvas);

        const myConfetti = confetti.create(canvas, { resize: true });

        const center = { x: 0.5, y: 0.5 };
        const maxOffset = 0.1; // ƒë·ªô l·ªách t·ªëi ƒëa quanh t√¢m

        // helper random l·ªách nh·∫π quanh trung t√¢m
        function randomNearCenter() {
            return {
                x: Math.min(0.65, Math.max(0.35, center.x + (Math.random() * 2 - 1) * maxOffset)),
                y: Math.min(0.65, Math.max(0.35, center.y + (Math.random() * 2 - 1) * maxOffset))
            };
        }

        for (let burst = 0; burst < 11; burst++) {
            setTimeout(() => {
                const origin = randomNearCenter();

                myConfetti({
                    particleCount: 6,
                    scalar: 1.8, 
                    angle: 0,
                    spread: 360,
                    startVelocity: 30,
                    gravity: 0.85,
                    ticks: 140,
                    origin,
                    colors
                });
            }, burst * 200); // 0.2s
        }

        // Cleanup canvas
        setTimeout(() => {
            document.body.removeChild(canvas);
        }, 11 * 200 + 3000);
    }



    /* ===== MUSIC BUTTON ===== */
    const bgMusic = new Audio(
      "https://raw.githubusercontent.com/HuyNguyen-01/LixiPJ_43B/main/resouce/1.mp3"
    );
    bgMusic.loop = true;

    const musicBtn = document.getElementById("musicBtn");
    let isMusicPlaying = false;

    musicBtn.addEventListener("click", () => {
        if (audioCtx.state === 'suspended') audioCtx.resume();

        if (!isMusicPlaying) {
            bgMusic.play();
            musicBtn.classList.add("playing");
        } else {
            bgMusic.pause();
            bgMusic.currentTime = 0;
            musicBtn.classList.remove("playing");
        }

        isMusicPlaying = !isMusicPlaying;
    });

    window.addEventListener('resize', () => {
        // N·∫øu ƒëang kh√¥ng quay, h√£y t√≠nh to√°n l·∫°i v·ªã tr√≠ hi·ªán t·∫°i ho·∫∑c init l·∫°i
        if (!isRollingState) {
            initColumns(); 
            // Ho·∫∑c c·∫≠p nh·∫≠t l·∫°i transform theo ƒë∆°n v·ªã px m·ªõi
        }
    });

    document.addEventListener("DOMContentLoaded", () => {
      loadMoneyConfig();
    });
</script>
</body>
</html>